
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Compilation and reference of important home automation">
      
      
      
      
        <meta name="author" content="Alex van den Hoogen">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.7">
    
    
      
        <title>Enabling QNAP disk spindown - Alex's Home Assistant documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.19753c6b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.196e0c26.min.css">
        
          
          
          <meta name="theme-color" content="#02a6f2">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="light-blue" data-md-color-accent="teal">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#enabling-qnap-disk-spindown" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Alex&#39;s Home Assistant documentation" class="md-header-nav__button md-logo" aria-label="Alex's Home Assistant documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 12l10-9 10 9h-3v8H5v-8H2m10 6l.72-.66C15.3 15 17 13.46 17 11.57c0-1.54-1.21-2.75-2.75-2.75-.87 0-1.7.41-2.25 1.05a3.007 3.007 0 00-2.25-1.05C8.21 8.82 7 10.03 7 11.57c0 1.89 1.7 3.43 4.28 5.77L12 18z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Alex's Home Assistant documentation
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Enabling QNAP disk spindown
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/alex3305/home-assistant-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    alex3305/home-assistant-docs
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Alex&#39;s Home Assistant documentation" class="md-nav__button md-logo" aria-label="Alex's Home Assistant documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 12l10-9 10 9h-3v8H5v-8H2m10 6l.72-.66C15.3 15 17 13.46 17 11.57c0-1.54-1.21-2.75-2.75-2.75-.87 0-1.7.41-2.25 1.05a3.007 3.007 0 00-2.25-1.05C8.21 8.82 7 10.03 7 11.57c0 1.89 1.7 3.43 4.28 5.77L12 18z"/></svg>

    </a>
    Alex's Home Assistant documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/alex3305/home-assistant-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    alex3305/home-assistant-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../installation/host-system/" class="md-nav__link">
      Custom installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
    <label class="md-nav__link" for="nav-3">
      Hardware
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Hardware" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Hardware
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../hardware/ikea-tradfri-open-close-remote/" class="md-nav__link">
      IKEA TRADFRI open/close remote
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../hardware/silvercrest-led-string-lights/" class="md-nav__link">
      Silvercrest LED String Lights
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" >
    <label class="md-nav__link" for="nav-4">
      Home Assistant
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Home Assistant" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Home Assistant
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../home-assistant/hacs/" class="md-nav__link">
      HACS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../home-assistant/xiaomi-tokens/" class="md-nav__link">
      Xiaomi Tokens
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" >
    <label class="md-nav__link" for="nav-5">
      Home Assistant Add-ons
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Home Assistant Add-ons" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Home Assistant Add-ons
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../add-ons/bitwarden/" class="md-nav__link">
      Bitwarden
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2" >
    <label class="md-nav__link" for="nav-5-2">
      InfluxDB
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="InfluxDB" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        <span class="md-nav__icon md-icon"></span>
        InfluxDB
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../add-ons/influxdb/" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../add-ons/influxdb-backup/" class="md-nav__link">
      Backup and restore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../add-ons/influxdb-downsampling/" class="md-nav__link">
      Downsampling (RP/CQ)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../add-ons/vscode/" class="md-nav__link">
      VSCode
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    <label class="md-nav__link" for="nav-6">
      Homelab
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Homelab" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Homelab
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Enabling QNAP disk spindown
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Enabling QNAP disk spindown
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-qts-storage" class="md-nav__link">
    Disable QTS storage
  </a>
  
    <nav class="md-nav" aria-label="Disable QTS storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#finding-out-which-drives-to-disable" class="md-nav__link">
    Finding out which drives to disable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disconnecting-the-qts-raid1-array" class="md-nav__link">
    Disconnecting the QTS RAID1 array
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebuilding-the-qts-raid1-array" class="md-nav__link">
    Rebuilding the QTS RAID1 array
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-swap" class="md-nav__link">
    Disable swap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autorun" class="md-nav__link">
    Autorun
  </a>
  
    <nav class="md-nav" aria-label="Autorun">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#editing-autorun" class="md-nav__link">
    Editing autorun
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autorun-script" class="md-nav__link">
    Autorun script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../qnap-linux-mount/" class="md-nav__link">
      Mounting QNAP disks in Debian Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../plex-transcoding-fix/" class="md-nav__link">
      Plex QSV transcoding fix
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-qts-storage" class="md-nav__link">
    Disable QTS storage
  </a>
  
    <nav class="md-nav" aria-label="Disable QTS storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#finding-out-which-drives-to-disable" class="md-nav__link">
    Finding out which drives to disable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disconnecting-the-qts-raid1-array" class="md-nav__link">
    Disconnecting the QTS RAID1 array
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebuilding-the-qts-raid1-array" class="md-nav__link">
    Rebuilding the QTS RAID1 array
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-swap" class="md-nav__link">
    Disable swap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autorun" class="md-nav__link">
    Autorun
  </a>
  
    <nav class="md-nav" aria-label="Autorun">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#editing-autorun" class="md-nav__link">
    Editing autorun
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autorun-script" class="md-nav__link">
    Autorun script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/alex3305/home-assistant-docs/edit/master/docs/homelab/qnap-disk-spindown.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="enabling-qnap-disk-spindown">Enabling QNAP disk spindown</h1>
<p>I like to enable disk spindown within my NAS to save on power consumption. This behaviour should be enabled by default, but in my case it wasn't working correctly. After some time scouring the internet, I found that many users were having the same issues. </p>
<p>With some online resources I found a way to truly enable QNAP disk spindown.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is advanced usage. Please bear in mind that this modifies your default NAS behaviour.</p>
</div>
<h2 id="requirements">Requirements</h2>
<ul>
<li>QNAP NAS</li>
<li>NVMe SSD installed into your NAS</li>
</ul>
<h2 id="disable-qts-storage">Disable QTS storage</h2>
<p>QTS creates a RAID1 array across all your drives inside of your NAS for it's OS storage. Initially I thought this was a clever idea. But it can (and will) prevent your drives from spindown. Even if you have a NVMe SSD installed. Since SSD's rarely die from wear in normal use, I decided to disable this RAID1 array most of the time.</p>
<p>However we rebuild this array once a day to keep our data synced to all our drives. Just in case a drive failure occurs. More on that later.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I've added this script to my <code>/shares/scripts/</code> directory, but it can also be placed inside of your <code>/root/</code> (or <code>~</code>) directory.</p>
</div>
<h3 id="finding-out-which-drives-to-disable">Finding out which drives to disable</h3>
<p>Just run <code>cat /proc/mdstat</code> which would return something like this:</p>
<div class="highlight"><pre><span></span><code>Personalities : [linear] [raid0] [raid1] [raid10] [raid6] [raid5] [raid4] [multipath]

...

md13 : active raid1 sdd[3] sdb[2] sda[1] nvme0n1p4[0]
      458880 blocks super 1.0 [32/1] [U_______________________________]
      bitmap: 1/1 pages [4KB], 65536KB chunk

md9 : active raid1 sdd[3] sdb[2] sda[1] nvme0n1p4[0]
      530048 blocks super 1.0 [32/1] [U_______________________________]
      bitmap: 1/1 pages [4KB], 65536KB chunk
</code></pre></div>
<p>Since I've installed an NVMe drive, I only want to retain that drive for my QTS storage. Remember the other drives, because you will need to edit the scripts below to fit your storage solution.</p>
<h3 id="disconnecting-the-qts-raid1-array">Disconnecting the QTS RAID1 array</h3>
<p>First up we add a script to disconnect our internal QTS RAID1 array.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nv">HDDS</span><span class="o">=</span><span class="s2">&quot;sda sdb sdd&quot;</span>

errquit<span class="o">()</span> <span class="o">{</span>
    <span class="nv">STATUS</span><span class="o">=</span><span class="m">1</span>
    _errlog <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
    <span class="nb">exit</span> <span class="si">${</span><span class="nv">STATUS</span><span class="si">}</span>
<span class="o">}</span>

<span class="nb">echo</span> <span class="s2">&quot;Disconnecting hdd&#39;s from /dev/md9 array&quot;</span>

<span class="k">for</span> disk in <span class="si">${</span><span class="nv">HDDS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> ! -e /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        errquit <span class="s2">&quot;Could not find /dev/</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
        mdadm /dev/md9 --fail /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="m">1</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Disconneting hdd&#39;s from /dev/md13 array&quot;</span>

<span class="k">for</span> disk in <span class="si">${</span><span class="nv">HDDS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> ! -e /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        errquit <span class="s2">&quot;Could not find /dev/</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
        mdadm /dev/md13 --fail /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="m">4</span>
    <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You should modify the <code>HDDS</code> parameter to suit your NAS and drive configuration.</p>
</div>
<h3 id="rebuilding-the-qts-raid1-array">Rebuilding the QTS RAID1 array</h3>
<p>Second up, we add a script to rebuild our QTS array once a day for data integrity should my NVMe drive fail.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nv">HDDS</span><span class="o">=</span><span class="s2">&quot;sda sdb sdd&quot;</span>

errquit<span class="o">()</span> <span class="o">{</span>
    <span class="nv">STATUS</span><span class="o">=</span><span class="m">1</span>
    _errlog <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="o">}</span>

<span class="nb">echo</span> <span class="s2">&quot;Rebuilding hdd&#39;s to /dev/md9 array&quot;</span>

<span class="k">for</span> disk in <span class="si">${</span><span class="nv">HDDS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> ! -e /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        errquit <span class="s2">&quot;Could not find /dev/</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
        mdadm /dev/md9 --re-add /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="m">1</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Rebuilding hdd&#39;s to /dev/md13 array&quot;</span>

<span class="k">for</span> disk in <span class="si">${</span><span class="nv">HDDS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> ! -e /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        errquit <span class="s2">&quot;Could not find /dev/</span><span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
        mdadm /dev/md13 --re-add /dev/<span class="si">${</span><span class="nv">disk</span><span class="si">}</span><span class="m">4</span>
    <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
<h2 id="disable-swap">Disable swap</h2>
<p>Since I've added 8GB of RAM to my NAS, I decided to disable swap memory. Because swap is also shared between (hard)drives. You could also add a swap file on the NVMe storage if you still want swap enabled.</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;Turning system swap off&quot;</span>
swapoff -a
</code></pre></div>
<h2 id="autorun">Autorun</h2>
<p>To get this all going, you can edit QTS's autorun file. Editing this file is different on different NAS devices. You can check QNAP's documentation on how to edit this file on your NAS.</p>
<h3 id="editing-autorun">Editing autorun</h3>
<div class="highlight"><pre><span></span><code>mount <span class="k">$(</span>/sbin/hal_app --get_boot_pd <span class="nv">port_id</span><span class="o">=</span><span class="m">0</span><span class="k">)</span><span class="m">6</span> /tmp/config
vi /tmp/config/autorun.sh
chmod +x /tmp/config/autorun.sh
umount /tmp/config
</code></pre></div>
<h3 id="autorun-script">Autorun script</h3>
<div class="highlight"><pre><span></span><code><span class="k">if</span> crontab -l <span class="p">|</span> grep -q <span class="s1">&#39;rebuild_internal_raid&#39;</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Nothing to do; /etc/config/ is on a persistent storage and was already modified</span>
    :
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;15 10 * * * /share/scripts/rebuild_internal_raid.sh&quot;</span> &gt;&gt; /etc/config/crontab
    crontab /etc/config/crontab <span class="o">&amp;&amp;</span> /etc/init.d/crond.sh restart
<span class="k">fi</span>

<span class="k">if</span> crontab -l <span class="p">|</span> grep -q <span class="s1">&#39;disconnect_internal_raid&#39;</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Nothing to do; /etc/config/ is on a persistent storage and was already modified</span>
    :
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;30 10 * * * /share/scripts/disconnect_internal_raid.sh&quot;</span> &gt;&gt; /etc/config/crontab
    crontab /etc/config/crontab <span class="o">&amp;&amp;</span> /etc/init.d/crond.sh restart
<span class="k">fi</span>

<span class="nb">exec</span> /share/scripts/disconnect_internal_raid.sh

<span class="nb">echo</span> <span class="s2">&quot;Turning system swap off&quot;</span>
swapoff -a
</code></pre></div>
<h2 id="references">References</h2>
<ul>
<li>https://www.reddit.com/r/qnap/comments/fhh61n/new_ts328_hdds_not_spinning_down_qnap_say_its/</li>
<li>https://forum.qnap.com/viewtopic.php?t=130788</li>
<li>https://wiki.qnap.com/wiki/Add_items_to_crontab</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../add-ons/vscode/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                VSCode
              </div>
            </div>
          </a>
        
        
          <a href="../qnap-linux-mount/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Mounting QNAP disks in Debian Linux
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.0ac82a11.min.js"></script>
      <script src="../../assets/javascripts/bundle.f81dfb4d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>